<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/index.css" />
  <!--index.css 내용을 가져와서 내용을 꾸며준다.-->
  <title>The search service</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Jua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <style>
    body {
      background-color: RGBA;
      min-height: 100vh;
    }

    .title {
      font-weight: 800;
      font-size: 5rem;
      font-family: 'Black Han Sans', sans-serif;
    }

    a:link {
      text-decoration: none;
      color: rgb(31, 1, 58);
    }

    a:visited {
      text-decoration: none;
      color: rgb(31, 1, 58);
    }

    a:hover {
      text-decoration: none;
      color: black;
    }

    a:active {
      text-decoration: none;
      color: rgb(31, 1, 58);
    }

    .carousel {
      width: 650px;
      height: 400px;
    }

    .imageblock {
      max-width: 100%;
      height: auto;
      border: 2px solid #eaeaea;
      padding: 0px;

      cursor: pointer
    }

    .review-card {
      position: static;
      float: center;
      height: auto;
      width: 1000px;
      margin-top: 10px;
      margin-left: 10px;
      padding: 10px 10px 10px 10px;
      top: 250px;
      border: 4px solid black;
      border-radius: 7px;
      overflow: auto;
    }

    .name {
      position: relative;
      text-align: right;
      font-weight: bolder;
      margin: 10px auto;
      height: auto;
      width: auto;
    }

    .img {
      position: relative;
      float: right;
      margin-top: 10px;
      margin-right: 10px;
      margin-bottom: 10px;
      height: auto;
      width: auto;
    }

    .review {
      position: relative;
      float: left;
      padding: 10px 10px 10px 10px;
      height: auto;
      width: 70%;
      border: 2px solid black;
      border-radius: 7px;
      margin: 10px 10px 10px 10px;
    }

    .playtime {
      float: right;
      font-weight: normal;
      margin-right: 10px;
    }

    .votes_up {
      float: left;
      font-weight: normal;
      margin-left: 10px;
    }

    .votes_funny {
      float: left;
      font-weight: normal;
      margin-left: 10px;
    }

    .textbox {
      width: 100%;
      height: 100%;
      position: absolute;
      z-index: 2;
      background-color: rgba(0, 0, 0, 0.8);
    }

    .login_button {
      float: right;
      margin: 20px 20px auto auto;
    }
  </style>

  <script type="text/javascript">
    const spinner = `
      <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      `
    // 페이지 로딩하자마자 실행할 함수
    $(document).ready(function () {
      // 로그인
      isLogin();
      // 추천배너
      // showRecommendedGames();
    });

    // 검색 엔터키로 가능하게 하기
    function enterkey() {
      if (window.event.keyCode == 13) {
        check();
      }
    }

    // 로그아웃
    function sign_out() {
      $.removeCookie("Bearer", { path: "/" });
      alert("로그아웃");
      window.location.href = "/";
    }

    // 로그인 상태에 따라 로그인, 로그아웃 버튼 다르게 만들기
    function isLogin() {
      const cookie = $.cookie("Bearer");
      let temp_html;
      if (cookie) {
        temp_html = `<input type="submit" value="로그아웃" onclick="sign_out()" class="login_button">`;
      } else {
        temp_html = `<input type="submit" value="로그인" onclick="location.href='/user/login'" class="login_button">`;
      }
      $("#isLogin").append(temp_html);
    }

    // 넣은 키워드가 있는지 검사
    function check() {
      var search = document.querySelector("#search").value;

      if (search == "") {
        alert("검색어를 입력해주세요");
        event.preventDefault();
      } else {
        show_games();
      }
    }

    // 검색 페이지로 이동
    function show_games() {
      let keyword = $("#search").val();
      let language = $("#language").val();
      let voted_up = $("#voted_up").val();
      const filterExists = language === 'none' && voted_up === 'none' ? false : true
      const data = {
        'keyword': keyword,
        'filterExists': filterExists,
        'filter': {
          'language': language,
          'voted_up': voted_up,
        },
        'slice_start': '0'
      }
      localStorage.setItem("data", JSON.stringify(data));
      location.href = '/search'
    }

    // 이미지를 클릭시 해당 게임 검색
    function show_reviews_appid(appid) {
      $("#bundle").empty()
      $("#spinner").append(spinner)
      let count = document.querySelectorAll('#game').length
      // console.log(appid, count)
      $.ajax({
        type: "GET",
        url: `/search/appid?appid=${appid}&slice_start=${count}`,
        data: {},
        success: function (response) {
          response = response.data
          if (!response.length) {
            let temp_html = `
            <div class="name">
              <h3>~검색결과 없음~</h3>
            </div>`
            $("#game-list").append(temp_html);
            $("#spinner").empty();
            return;
          }
          appending(response)
          // 필터넣는 버튼, 안넣는 버튼 구분해야해서 매번 만들어줘야함
          if (response.length >= 30) {
            $("#bundle").append(
              `<div class="d-grid gap-2">
                <button class="btn btn-dark" type="button" onclick="show_reviews_appid(${response[0]._source.appid})" style="margin-bottom: 20px">30개 더보기</button>
              </div>`)
          }
        }
      });
    }
    function show_with_Filter(appid, isfirst) {
      // 30개 버튼 없애준다? 스피너랑 다른 div 쓰면 되지않나
      $("#bundle").empty()
      if (isfirst == true) $("#game-list").empty();
      $("#spinner").append(spinner)
      let language = $("#language").val();
      let voted_up = $("#voted_up").val();
      let count = document.querySelectorAll('#game').length
      $.ajax({
        type: "POST",
        url: `/search/appid`,
        data: {
          'appid': `${appid}`,
          'filterExists': language === 'none' && voted_up === 'none' ? false : true,
          'filter': {
            'language': `${language}`,
            'voted_up': voted_up,
          },
          'slice_start': `${count}`
        },
        success: function (response) {
          response = response.data
          if (!response.length) {
            let temp_html = `
            <div class="name">
              <h3>~검색결과 없음~</h3>
            </div>`
            $("#game-list").append(temp_html);
            $("#spinner").empty();
            return;
          }
          appending(response)
          // 필터넣는 버튼, 안넣는 버튼 구분해야해서 매번 만들어줘야함
          if (response.length >= 30) {
            $("#bundle").append(
              `<div class="d-grid gap-2">
                <button class="btn btn-dark" type="button" onclick="show_with_Filter(${response[0]._source.appid}, false)" style="margin-bottom: 20px">30개 더보기</button>
              </div>`)
          }
        }
      });
    }
    function appending(response) {
      $("#spinner").empty();
      for (let i = 0; i < response.length; i++) {
        let temp_html = `<div class="review-card" id="game">
            <blockquote class="blockquote mb-0">
              <div class="name">
                <h1 style="cursor:pointer;" onclick='location.href="https://store.steampowered.com/app/${response[i]._source.appid}/"'>
                  스팀 바로가기
                </h1>
                <br>
                ${Date(response[i]._source.timestamp_updated)}
                  / ${response[i]._source.voted_up == true ? '추천' : '추천안함'}
                    <div class="playtime">playtime: ${response[i]._source.playtime_at_review} 시간
                    </div>
                    <div class="votes_up">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-hand-thumbs-up" viewBox="0 0 16 16">
                        <path
                          d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z" />
                      </svg>
                      ${response[i]._source.votes_up}
                    </div>
                    <div class="votes_funny">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-emoji-laughing" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                        <path
                          d="M12.331 9.5a1 1 0 0 1 0 1A4.998 4.998 0 0 1 8 13a4.998 4.998 0 0 1-4.33-2.5A1 1 0 0 1 4.535 9h6.93a1 1 0 0 1 .866.5zM7 6.5c0 .828-.448 0-1 0s-1 .828-1 0S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 0-1 0s-1 .828-1 0S9.448 5 10 5s1 .672 1 1.5z" />
                      </svg>
                      ${response[i]._source.votes_funny}
                    </div>
              </div>
              <div class="review">
                ${response[i]["_source"]["review"].replace(/(?:\r\n|\r|\n)/g, "<br>")}
              </div>
            </blockquote>
          </div>`;
        $(`#game-list`).append(temp_html);
      }
      // 30개버튼은 안없애다가 오는 양이 적어지면 없애는걸로
      // 아 근데 그러면 갯수를 못세내...가 아니라 그냥 여기와서 세면 안되나?
    }
  // 추천배너 없음

  </script>
</head>

<body>

  <section style="display: flex;flex-direction: column;justify-content: center; align-items: center;" id="isLogin">
  </section>
  <section style="display: flex;flex-direction: column;justify-content: center; align-items: center;">
    <h1 class="title"><a href="/">Steam Search Service</a></h1>
    <!--웹페이지 안에 스팀포유 띄움. 그리고 css 파일에 red함수를 가져와서 쓴다.-->

    <!-- <form method="get" action="search"> -->
    <div class="name">
      <input type="text" placeholder="검색어를 입력하세요.." id="search" onkeyup="enterkey();" style="width: 500px;"
        value="<%= result? name : '' %>" />
      <input id="submit" type="submit" value="검색" onclick="show_games()" />
    </div>

    <div class="name">
      <select name="language" id="language">
        <option value="none">언어: ALL</option>
        <option value="koreana">korean</option>
        <option value="english">english</option>
      </select>
      <select name="voted_up" id="voted_up">
        <option value="none">추천여부: ALL</option>
        <option value=true>추천</option>
        <option value=false>비추천</option>
      </select>
      <button id="submit_filter" type="submit" onclick="show_with_Filter('<%= data[0]._source.appid %>', true)">
        필터로 보기
      </button>
    </div>

  </section>
  <section style="display: flex;flex-direction: column;justify-content: center; align-items: center;">
    <div class="game-list" id="game-list">
      <% if (data.length) { %>
        <% for (let i=0; i < data.length; i++) { %>
          <div class="review-card" id="game">
            <blockquote class="blockquote mb-0">
              <div class="name">
                <h1 style="cursor:pointer;" onclick='location.href="https://store.steampowered.com/app/<%= appid %>/"'>
                  스팀 바로가기
                </h1>
                <br>
                <%= Date(data[i]._source.timestamp_updated) %>
                  / <%= data[i]._source.voted_up==true ? '추천' : '추천안함' %>
                    <div class="playtime">playtime: <%= data[i]._source.playtime_at_review %> 시간
                    </div>
                    <div class="votes_up">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-hand-thumbs-up" viewBox="0 0 16 16">
                        <path
                          d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z" />
                      </svg>
                      <%= data[i]._source.votes_up %>
                    </div>
                    <div class="votes_funny">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-emoji-laughing" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                        <path
                          d="M12.331 9.5a1 1 0 0 1 0 1A4.998 4.998 0 0 1 8 13a4.998 4.998 0 0 1-4.33-2.5A1 1 0 0 1 4.535 9h6.93a1 1 0 0 1 .866.5zM7 6.5c0 .828-.448 0-1 0s-1 .828-1 0S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 0-1 0s-1 .828-1 0S9.448 5 10 5s1 .672 1 1.5z" />
                      </svg>
                      <%= data[i]._source.votes_funny %>
                    </div>
              </div>
              <div class="review">
                <%- data[i]["_source"]["review"].replace(/(?:\r\n|\r|\n)/g, "<br>" ) %>
              </div>
            </blockquote>
          </div>`
          <% } %>
            <% } else { %>
              <h1>결과없음</h1>
              <% } %>
    </div>
    <div id="bundle" style="width: 1010px">
      <% if (data.length>= 30) { %>
        <div class="d-grid gap-2">
          <button class="btn btn-dark" type="button" onclick="show_reviews_appid('<%= data[0]._source.appid %>')"
            style="margin-bottom: 20px">
            30개 더보기
          </button>
        </div>
        <% } %>
    </div>
    <div id="spinner" style="width: 1010px">
    </div>
  </section>
  <!-- </form> -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
    crossorigin="anonymous"></script>
</body>

<script></script>

</html>